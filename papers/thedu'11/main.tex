\documentclass[submission,copyright]{eptcs}
\providecommand{\event}{THedu 2011} % Name of the event you are submitting to
\usepackage{breakurl}             % Not needed if you use pdflatex only.
\usepackage{amssymb, amsmath}

\newcommand{\coq}{Coq}
\newcommand{\coqtail}{\textsc{coqtail}}
\newcommand{\N}{\mathbb{N}}
\newcommand{\R}{\mathbb{R}}
\newcommand{\Rbar}{\overline{\mathbb{R}}}

\DeclareMathOperator{\D}{\mathtt{An\_deriv}}
\DeclareMathOperator{\cvrw}{\mathtt{Cv\_radius\_weak}}
\DeclareMathOperator{\fcvr}{\mathtt{finite\_cv\_radius}}
\DeclareMathOperator{\icvr}{\mathtt{infinite\_cv\_radius}}

\newtheorem{definition}{Definition}
\newtheorem{lemma}{Lemma}
\newtheorem{theorem}{Theorem}

\title{\coq{} with power series}
\author{XXX
\institute{Junior Laboratory \coqtail{}\\
Ens Lyon - France\\}
\email{XXX}}
\def\titlerunning{\coq{} with power series}
\def\authorrunning{XXX, \coqtail{} team}

\begin{document}
\maketitle

\begin{abstract}
Even if the trigonometric functions are defined in \coq{}'s standard
library, they were not described as power series because of a lack of
formalisation of this concept.
We present the strategy chosen to describe the power series over $\R$
and then advocates for the broad use of such abstract concepts by
showing the immediate benefits that one can get from this approach.

These benefits include the possibility to redefine the usual functions
($\sin$, $\cos$, $\exp$, ...) in a few lines, to get some of their
properties for free (eg. being in the $C^{\infty}$ class) and to prove
that they are solutions of particular differential equations just by
studying sequences over the reals.

\textbf{Files:} all the results mentioned in this paper are available on
\coqtail{}'s svn repository\footnote{see
\url{http://sourceforge.net/projects/coqtail/develop}
and in particular \texttt{src/Reals/Rpser.v}.} and will
be part of the next release.

\end{abstract}

\section{Formalization}

Formalizing power series in an interactive theorem prover is not really
about design choices: any good undergraduate textbook introduces the
power series through definitions and a sequence of steps whose
ordering makes sense. Our library is therefore really close to what one
can find in such a textbook except for one point: the definition of the
convergence radius.

In an intuitionistic setting, our definition of the radius of convergence
is much more informative than the usual one. This design choice allowed
us to get rid of the excluded-middle (EM) axiom in almost all the proofs
that usually use it without preventing us from proving lemmas whose
conclusions are now strengthened\footnote{See d'Alembert's ratio
criterion for example.}. This is however not harmful given that our
definition has been proved classically equivalent to the traditional one.

\subsection{The convergence radius}

The convergence radius $\rho$ of a power series whose general term is
$(a_n)_{n \in \N}$ is usually defined as a lowest upper bound (in
$\R \cup \left\lbrace +\infty \right\rbrace$):

 $$\rho(\sum_{n \in \N} a_n x^n) = \sup \left\lbrace r \in \R ~|~
   \text{the sequence } \left|a_n r^n\right| \text{ is bounded}
   \right\rbrace$$

As being bounded is obviously not decidable, knowing that $r$ is the
convergence radius of $\sum_{n \in \N} a_n x^n$ is not sufficient to
show without using EM that for all x such that $x \in B(0,r)$, the
sequence $(\left| a_n x^n \right|)_{n \in \N}$ is bounded. That is why
we use an alternative definition which describes exactly the same
idea (being the lowest upper bound), is more verbose and, as a
consequence, easier to use.

\begin{definition}[Rpser\_def] We say that $r$ is a weak convergence
radius if it is a lower bound for the convergence radius (ie $r$ belongs
to the set described previously).
$$\cvrw{}(a_n,r) = \left| a_n r^n \right| \text{ is bounded}$$
\end{definition}

From this definition, we can derive the definition of the finite
convergence radius\footnote{The extension to the infinite case is
straightforward: the convergence radius is infinite if and only if
all the reals are weak convergence radiuses.}.

\begin{definition}[Rpser\_def] The convergence radius is finite and
equal to $r$ if $r$ is both bigger than all the weak convergence radiuses 
and smaller or equal to all the reals that are too big to be weak
convergence radiuses.
$$\fcvr{}(a_n,r) =
\begin{array}{clcl}
        & \forall r', & 0 \le r' < r & \Rightarrow \cvrw{}(a_n,r') \\
 \wedge & \forall r', & r < r' & \Rightarrow \neg \cvrw{}(a_n,r')
\end{array}$$
\end{definition}

The classical equivalence between this definition and the usual one is proved
throught the two following lemmas. Unsurprisingly, the first implication does
not need the excluded middle axiom: our definition is stronger in an EM-free
setting than the usual one.

\begin{lemma}[Rpser\_base\_facts] $\fcvr{}(a_n,r) \Rightarrow r = \sup \left\lbrace x |
\cvrw{}(a_n, x) \right\rbrace$ \end{lemma}

\begin{lemma}[Rpser\_base\_facts] $EM + r = \sup \left\lbrace x |
\cvrw{}(a_n, x) \right\rbrace \Rightarrow \fcvr{}(a_n,r)$ \end{lemma}

Once that we have these definitions and that we know that they are
equivalent to their usual counterparts, we can start manipulating them.
The first important tool that we can get is d'Alembert's ratio criterion.
It is rather useful to prove that a particular power series has a given
convergence radius; this result is for example used to prove that $\exp$
has an infinite convergence radius from which we can trivially deduce
that both $\cos$ and $\sin$ also do.

\begin{lemma}[Rpser\_cv\_facts] A weak version of Alembert's ratio
criterion given that for all $n$, $a_n \neq 0$:

$$\lim\limits_{n \to + \infty}\frac{a_{n+1}}{a_n} = \lambda \neq 0
  \Rightarrow \forall \left| r \right| < \frac{1}{\left| \lambda \right|
  }, \cvrw{}(a_n,r)$$
\end{lemma}

\subsection{Sum of a power series}

When we know what is the power series' convergence radius, we can start
summing it on the appropriate domain. Our beloved tool to define the sum
of a power series is obviously Abel's lemma which states that given a
convergence radius, we can sum the power series inside the corresponding
ball.

\begin{lemma}[Rpser\_radius\_facts] $$\cvrw{}(a_n,r) \Rightarrow
\forall x \in B(0,r), \exists l, \sum_{n=0}^{+\infty} a_n x^n = l$$
\end{lemma}

\begin{definition}[Rpser\_sums] From this lemma we can construct the functions
(namely \texttt{weaksum\_r}, \texttt{sum\_r} and \texttt{sum}) that given either
$\cvrw{}(a_n,r)$, $\fcvr{}(a_n,r)$ or $\icvr{}(a_n)$ output the piecewise-defined
function: $$x \mapsto \left\lbrace
\begin{array}{ll}
\sum_{n=0}^{+\infty} a_n x^n & \text{ if } x \text{ is inside the convergence
disk}\\
0 & \text{otherwise}
\end{array}\right.$$
\end{definition}

\subsection{Derivative of a power series}

The formalization of the derivative of a power series is done in two steps.
First of all, we define the formal derivative of a power series and prove
that this definition makes sense (eg. that the sum exists):

\begin{definition}[Rpser\_derivative] The formal derivative of the power
series defined by $(a_n)$ is the one defined by:
$$\D{}(a_n) = (n + 1) * a_{n+1}$$
\end{definition}

\begin{lemma}[Rpser\_radius\_facts] An its convergence radius is exactly
the same as the one of the original series: $$\fcvr{}(a_n,r) \Leftrightarrow
\fcvr{}(\D{}(a_n),r)$$\end{lemma}

We now know that the formal derivative is summable but we still have to
somehow explicit the relation that exists between these two power series.
This is maybe the most complex part of the library; it uses a theorem on
sequences of functions plus the fact that the sequence of the partial
sums of a power series converges normally (thus uniformly) inside the
convergence radius.

\begin{theorem}[RFsequence\_facts] If a sequence $(f_n)_{n \in \N}$ of
derivable functions converges to the limit function $f$ on a ball $B(c,r)$
and if the sequence of the derivatives $(f_n')_{n \in \N}$ converges
uniformly to $g$ on this same ball, then $f$ is derivable on $B(c,r)$ and
its derivative is $g$.\end{theorem}

This allows us to conclude that the power series are derivable and that
their derivative is precisely the sum of the formal derivative.
As the derivative of a power series is another power series, it is
trivial to show that the function defined as the sum belongs to the
$C^{\infty}$ class\footnote{See the C\_n\_* files for results on
function classes.}. As a consequence, we can get an explicit description
of the $n^{th}$ derivative of the sum by a simple induction:

\begin{lemma}[\texttt{Rpser\_derivative\_facts}] Explicit description of the
$k^{th}$ derivative of the power series defined by $(a_n)_{n\in \N}$:
$$(\sum_{n=0}^{+\infty} a_n x^n)^{(k)} = \sum_{n=0}^{+\infty}
\frac{(n + k)!}{n!} a_{n+k} x^n$$
\end{lemma}

\section{Applications}

\subsection{Defining usual functions}

Thanks to all the formalization work, we can now define all the usual
functions in a few lines. We begin by defining the exponential using
d'Alembert's ratio test to prove that its convergence radius is infinite
(which is rather easy).

Then we can get for free the fact that cosine and sine also have an
infinite convergence radius by using one of the basic lemmas:

\begin{lemma}[Rpser\_base\_facts] $\cvrw{}$ is compatible with the
pointwise order on the sequences over reals:

$$\left(\left|b_n\right| \le_{pointwise} \left|a_n\right|\right)
  \Rightarrow \forall r, \cvrw{}(a_n,r) \Rightarrow \cvrw{}(b_n,r)$$
\end{lemma}

We have been able to define $\exp$, $\sin$ and $\cos$ in less than 80
lines of Coq source code. It has to be compared to the hundreds
of lines and the ad-hoc arguments (eg. convergence of alternating series)
that Coq's standard library dedicates to the definition of these exact
same functions.

Not only defining these functions is much more easier, but we get for
free their derivability (and even their being in the $C^{\infty}$ class),
the exact shape of their $n^{th}$ derivative and therefore we can easily
prove the relation that exists between them.

\subsection{Finding solutions of linear differential equations}

On top of the power series formalization, we constructed a small library
that uses reflection to describe linear differential equations of
arbitrary shape. It is based on two things:

\begin{itemize}
 \item A datatype \texttt{side\_equa} that is a descriptor of linear 
   differential equations\footnote{A differential equation is a pair
   $(se_1,se_2)$ of side equations (usually written $se_1 :=: se_2$).} and whose grammar is:
	$$se ::= cst c ~|~ y_{i}^{(k)} ~|~ - se ~|~ se + se$$

 \item A (set of) semantics that given an inhabitant of this datatype
	and an environment outputs a proposition.
\end{itemize}

This representation and the attached semantics allows us to state general
theorems about linear differential equations. Our main result states that
given power series that have infinite convergence radiuses, one only has
to prove that there is a relation between the sequences in order to show
that the sums of the power series are in relation\footnote{See the
Dequa\_* files for more details.}.

%TODO: expand this if possible (less than 5 pages!)

By using this theorem, one can prove in less than 20 lines each that the
exponential, cosine and sine are respectively solutions of
$y^{(n+1)} = y^{(n)}$ and $y^{(2)} = - y$.

\section{Extensions}

\subsection{Power series on other carriers}

Coqtail already has a basic library on the power series over the complex
numbers (definitions, differentiability, derivability). A future work
could be to adapt the work done on the real numbers to the complex numbers.
A better idea might be to formalize the power series on a more general
structure (eg. a ring equipped with a norm).

\subsection{Improving the library on differential equations}

Even if the work on the differential equations is already quite
convenient, it is still rather limited: one can only derive variables
and not composed expressions, there is not built-in minus function and it
is impossible to talk about the product of power series.

Describing the explicit shape of the product of two power series (the
power series which is defined with the cauchy product of the sequences
defining the two others) is a possible future work.
\end{document}
